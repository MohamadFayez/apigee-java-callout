# JWS callout

For several years, Apigee has included builtin policies that generate and verify
signed JWT and JWS. As of June 2022, the built-in policies do not yet handle JWS
with non-base64url encoded payloads (detached or otherwise). (This is described
in [RFC 7797](https://datatracker.ietf.org/doc/html/rfc7797).)  This capagility
is in the Apigee roadmap, but in the meantime, you can generate and verify JWS
with non-base64url encoded payloads _today_, with this Java callout.

This repo contains the Java source code for two classes that can be used
in Apigee to :

* Generate a JWS with non-base64url encoded payload

* Verify a JWS with a non-base64url encoded payload

## License

This code is Copyright (c) 2017-2022 Google LLC, and is released under the
Apache Source License v2.0. For information see the [LICENSE](LICENSE) file.

## Disclaimer

This example is not an official Google product, nor is it part of an official Google product.

## Using the Custom Policy

You do not need to build the Jar in order to use the custom policy.

There are two different classes:

| class                                      | purpose                     |
|--------------------------------------------|-----------------------------|
| com.google.apigee.callouts.GenerateJws     | generate a JWS.             |
| com.google.apigee.callouts.VerifyJws       | verify a JWS.               |

When you use the policy to generate a JWS, the resulting JWS can be
verified by other systems that have access to the verification key. Likewise, when you use
the policy to verify a JWS, it  will work with any compliant JWS, generated by any other application.

## Policy Configuration

There is a variety of options. Some examples follow.

### Generation of a JWS signed with RS256

  ```xml
  <JavaCallout name="Java-GenerateJWS">
    <Properties>
      <!-- the context variable "my-private-key" must hold a PEM-encoded RSA private key -->
      <Property name='private-key'>{my-private-key}</Property>
      <Property name='key-id'>key1</Property>
      <Property name='algorithm'>RS256</Property>
      <Property name='payload'>whatever you like here</Property>
      <!-- additional-headers is a json hash -->
      <Property name='additional-headers'>{ "iat" : {system.timestamp} }</Property>
      <Property name='output'>jws-output</Property>
    </Properties>
    <ClassName>com.google.apigee.callouts.GenerateJws</ClassName>
    <ResourceURL>java://apigee-callout-jws-20220630.jar</ResourceURL>
  </JavaCallout>
  ```

Here's what will happen with this policy configuration:

* the class is GenerateJws, so the policy will Generate a JWS
* The private key will be deserialized from the PEM string in the variable `my-private-key`
* The JWS will be placed in the variable `jws-output`


### Generation of a JWS with no encoding on the payload


  ```xml
  <JavaCallout name="Java-GenerateJWS">
    <Properties>
      <!-- the context variable "my-private-key" must hold a PEM-encoded RSA private key -->
      <Property name='private-key'>{my-private-key}</Property>
      <Property name='key-id'>key1</Property>
      <Property name='algorithm'>RS256</Property>
      <Property name='payload'>whatever you like here</Property>
      <!-- additional-headers is a json hash -->
      <Property name='additional-headers'>{ "iat" : {system.timestamp} }</Property>
      <Property name='output'>jws-output</Property>
      <Property name='b64'>false</Property>
    </Properties>
    <ClassName>com.google.apigee.callouts.GenerateJws</ClassName>
    <ResourceURL>java://apigee-callout-jws-20220630.jar</ResourceURL>
  </JavaCallout>
  ```


### Generation of a JWS with no encoding on the payload, and a detached payload

  ```xml
  <JavaCallout name="Java-GenerateJWS">
    <Properties>
      <!-- the context variable "my-private-key" must hold a PEM-encoded RSA private key -->
      <Property name='private-key'>{my-private-key}</Property>
      <Property name='key-id'>key1</Property>
      <Property name='algorithm'>RS256</Property>
      <Property name='payload'>whatever you like here</Property>
      <!-- additional-headers is a json hash -->
      <Property name='additional-headers'>{ "iat" : {system.timestamp} }</Property>
      <Property name='output'>jws-output</Property>
      <Property name='b64'>false</Property>
      <Property name='detach'>true</Property>
    </Properties>
    <ClassName>com.google.apigee.callouts.GenerateJws</ClassName>
    <ResourceURL>java://apigee-callout-jws-20220630.jar</ResourceURL>
  </JavaCallout>
  ```

### Properties for Generation

These are the properties available on the GenerateJwe and GenerateEncryptedJwt policies:

| Property             | Description                                                                                                                           |
| -------------------- |-------------------------------------------------------------------------------------------------------------------------------------- |
| `algorithm`          | required. name of the algorithm. One of `RS256`, `PS256`, `ES256`, `HS256`, or stronger variants of same.                 |
| `private-key`          | required when action = "decrypt". a PEM string representing the private key.                                                              |
| `private-key-password` | optional. a password to use with an encrypted private key.                                                                                |
| `key-id`               | optional. the key-id for the header. If you specify this, the callout will insert the `kid` into the header.                                |
| `payload`              | required. The thing to sign. This is any arbitrary string. |
| `additional-headers`   | optional. a JSON string that includes additional custom properties for the header of the JWS. Do not include `crit` headers here. |
| `critical-headers`     | optional. a comma-separated list of header names to be used within the "crit" header of the JWT.                                          |
| `b64`                  | optional. A boolean. If false, the payload is not encoded before signing, and the callout inserts a b64 header, and inserts "b64" into the crit list. Defaults to true. |
| `detach`               | optional. A boolean. If true, detach the payload from the JWS. Defaults to false. |
| `output`               | optional. name of the variable in which to store the output. Defaults to `jws_output`                               |


### Basic Verification of a JWS

  ```xml
  <JavaCallout name="Java-VerifyJws">
    <Properties>
      <Property name='source'>input-jws</Property>
      <Property name='algorithm'>PS256</Property>
      <Property name='jwks-uri'>https://foobar/.well-known/jwks.json</Property>
    </Properties>
    <ClassName>com.google.apigee.callouts.VerifyJws</ClassName>
    <ResourceURL>java://apigee-callout-jws-20220630.jar</ResourceURL>
  </JavaCallout>
  ```

* the class is VerifyJws, so the policy will Verify a JWS. 
* The JWS will be obtained from the variable `input-jws`
* the algorithm is specified as PS256, so the policy will verify
  that the inbound JWS uses that algorithm, and will reject a JWS that uses any other algorithm.
* The policy will retrieve the JWKS from the specified uri.



### Properties for Verification

These are the properties available on the policy:

| Property               | Description                                                                                                                               |
|------------------------|-------------------------------------------------------------------------------------------------------------------------------------------|
| `public-key`         | optional. a PEM string representing the public key. You must specify one of {`public-key`, `jwks-uri`}.                       |
| `jwks-uri`           | optional. a URI that returns a JWKS payload. You must specify one of {`public-key`, `jwks-uri`}.                              |
| `algorithm`          | required. name of the algorithm. One of `RS256`, `PS256`, `ES256`, `HS256`, or stronger variants of same.                 |
| `source`               | optional. name of the context variable containing the variable holding the JWS to verify. |
| `critical-headers`     | optional. comma-separated list of header names that are acknowledged as critical; to be handled by the proxy later.  |


## About PEM-encoded Keys

Private keys should look like this:
```
-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDXk9k01JrhGQf1
8xaz45QmARgwI/g25gO8hP9iBABk3iNBY96+Kr65ReY8Ivof6Y2yha0ZPEwEfehQ
...
hHYu+QiRZnABbpD9C1+Akh4dG97Woyfd5igBsT1Ovs9PDCN0rO4I2nJHrNLJSPte
OtpRWoF2/LERvp6RNeXthgs=
-----END PRIVATE KEY-----
```



Public keys should look like this:
```
-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA15PZNNSa4RkH9eAeJ8ph
57WhvUmANpBEDqP0SuHzNl3HmxbEiUPBoBNQAtRpVlOWM0t+FltMORjGXtntjSBs
...
I3DFmXb0ny3uCUCfCRtHnpAU0gfjWBiwkZ/R2OhZOW877GGcNMKVTnFT6911gGMi
SwIDAQAB
-----END PUBLIC KEY-----
```


## About crit-headers

The JWS specification includes an option to specify ["critical
headers"](https://tools.ietf.org/html/rfc7515#section-4.1.11) in the
`crit` field of the header of the JWS. The value of the
`crit` field is a list of header names. Via this notation, the JWS asserts that
there are headers contained in the JWS which are critical and which MUST be
understood by any consumer or reader. The reader MUST reject any JWS containing
headers on the `crit` list that it does not understand.

To communicate headers that are understood, configure the policy with the
`critical-headers` property. When the `VerifyJws` 
callout processes an inbound JWS that contains a `crit`
header, the verification will succeed if and only if the header names listed in
the JWS `crit` header claim are also present in the `critical-headers` list in the policy
configuration.


## Example Bundle

There is an [example bundle](./bundle) that demonstrates the use of the API
Proxy.

Example request to generate a JWS:

```
ORG=myorg
ENV=myenv
curl -i -X POST https://$ORG-$ENV.apigee.net/jws/generate_jws -d ''
```

The result will be a JWS. You can paste it into a JWT decoder like [this
one](https://dinochiesa.github.io/jwt/) to examine the header. But since it's a
JWS there's no guarantee the payload will be JSON! 

## Building the Jar

You do not need to build the Jar in order to use the custom policy. The custom policy is
ready to use, with policy configuration. You need to re-build the jar only if you want
to modify the behavior of the custom policy. Before you do that, be sure you understand
all the configuration options - the policy may be usable for you without modification.

If you do wish to build the jar, you can use
[maven](https://maven.apache.org/download.cgi) to do so. The build requires
JDK8. Before you run the build the first time, you need to download the Apigee
dependencies into your local maven repo.

Preparation, first time only: `./buildsetup.sh`

To build: `mvn clean package`

The source code includes tests.

If you edit policies offline, copy [the jar file for the custom
policy](callout/target/apigee-callout-jws-20220630.jar) and all the
dependencies to your apiproxy/resources/java directory.  If you don't edit proxy
bundles offline, upload that jar file into the API Proxy via the Apigee API
Proxy Editor .


## Build Dependencies

* Apigee expressions v1.0 (provided)
* Apigee message-flow v1.0 (provided)
* Bouncy Castle 1.67 (provided)
* NimbusDS jose-jwt v8.22
* other dependencies of NimbusDS jose-jwt
* Ben Manes' caffeine v2.9.0

These dependencies are specified in the pom.xml file.

You will need to upload the output jar, as well as jose-jwt jar and its
dependencies as resources to your Apigee instance, either with the API Proxy or
with the organization or environment.

## Author

Dino Chiesa
godino@google.com

## Bugs & Limitations

* The tests are incomplete.
